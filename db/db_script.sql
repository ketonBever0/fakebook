-- Teljes adatbázist generáló szkript a truevoly/oracle-12c Docker képfájlhoz (egyéb Oracle 12c-t futtató képfájllal/szerverrel is működhet)
-- A futtatáshoz rendelkezzünk felhasználó készítését és sémájuk szerkesztését biztosító vagy DBA jogosultsággal ("sys" fiók megteszi)
-- A "CREATE INDEX" parancsokat kivettem, mert a táblával együtt egyébként is létrejönnek, emiatt hibát dobtak, miszerint léteznek

-- A táblák létrehozás után feltöltődnek adatokkal
-- Az ID- és bizonyos dátum mezők szándékosan vannak kihagyva demonstrálva a szekvenciák és a SYSDATE megfelelő működését


-- DROP USER FAKEBOOK CASCADE;
-- ^ Ha újra akarod generálni a sémát vedd ki a kommentet a fenti sorból,
-- DE előtte állítsd le a backendet


CREATE USER fakebook
IDENTIFIED BY "fkbU#123"
DEFAULT TABLESPACE users
QUOTA 200M ON users;

GRANT CREATE SESSION, CREATE TABLE, CREATE VIEW, CREATE SEQUENCE, CREATE SYNONYM TO fakebook;

CREATE SEQUENCE FAKEBOOK.COMMENTS_ID_SEQ INCREMENT BY 1 MINVALUE 100 MAXVALUE 9999999999999999999999999999 NOCYCLE NOCACHE ORDER ;

CREATE SEQUENCE FAKEBOOK.FRIENDS_ID_SEQ INCREMENT BY 1 MINVALUE 100 MAXVALUE 9999999999999999999999999999 NOCYCLE NOCACHE ORDER ;

CREATE SEQUENCE FAKEBOOK.GROUPS_ID_SEQ INCREMENT BY 1 MINVALUE 100 MAXVALUE 9999999999999999999999999999 NOCYCLE NOCACHE ORDER ;

CREATE SEQUENCE FAKEBOOK.GROUP_MESSAGES_ID_SEQ INCREMENT BY 1 MINVALUE 100 MAXVALUE 9999999999999999999999999999 NOCYCLE NOCACHE ORDER ;

CREATE SEQUENCE FAKEBOOK.INTERESTS_ID_SEQ INCREMENT BY 1 MINVALUE 100 MAXVALUE 9999999999999999999999999999 NOCYCLE NOCACHE ORDER ;

CREATE SEQUENCE FAKEBOOK.MESSAGES_ID_SEQ INCREMENT BY 1 MINVALUE 100 MAXVALUE 9999999999999999999999999999 NOCYCLE NOCACHE ORDER ;

CREATE SEQUENCE FAKEBOOK.POSTS_ID_SEQ INCREMENT BY 1 MINVALUE 100 MAXVALUE 9999999999999999999999999999 NOCYCLE NOCACHE ORDER ;

CREATE SEQUENCE FAKEBOOK.USERS_ID_SEQ INCREMENT BY 1 MINVALUE 100 MAXVALUE 9999999999999999999999999999 NOCYCLE NOCACHE ORDER ;

CREATE SEQUENCE FAKEBOOK.USER_GROUPS_ID_SEQ INCREMENT BY 1 MINVALUE 100 MAXVALUE 9999999999999999999999999999 NOCYCLE NOCACHE ORDER ;

CREATE SEQUENCE FAKEBOOK.USER_INTERESTS_ID_SEQ INCREMENT BY 1 MINVALUE 100 MAXVALUE 9999999999999999999999999999 NOCYCLE NOCACHE ORDER ;

CREATE SEQUENCE FAKEBOOK.FORBIDDEN_EXPRESSIONS_ID_SEQ INCREMENT BY 1 MINVALUE 100 MAXVALUE 9999999999999999999999999999 NOCYCLE NOCACHE ORDER ;

-- Táblák létrehozása
CREATE TABLE "FAKEBOOK"."USERS" 
   (	"ID" NUMBER(38,0) DEFAULT ON NULL "FAKEBOOK"."USERS_ID_SEQ".NEXTVAL NOT NULL ENABLE, 
	"EMAIL" VARCHAR2(100) NOT NULL ENABLE, 
	"FULLNAME" VARCHAR2(100) NOT NULL ENABLE, 
	"PASSWORD" VARCHAR2(100) NOT NULL ENABLE, 
	"BIRTH_DATE" DATE NOT NULL ENABLE, 
	"COMPANY" VARCHAR2(100) NOT NULL ENABLE, 
	"PICTURE_URL" VARCHAR2(100), 
	"REGISTERED_AT" DATE DEFAULT SYSDATE NOT NULL ENABLE, 
	"LAST_LOGIN" DATE DEFAULT SYSDATE NOT NULL ENABLE, 
	 CONSTRAINT "USERS_PK" PRIMARY KEY ("ID")
  USING INDEX PCTFREE 10 INITRANS 2 MAXTRANS 255 
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "USERS"  ENABLE, 
	 CONSTRAINT "USERS_EMAIL_UNIQUE" UNIQUE ("EMAIL")
  USING INDEX PCTFREE 10 INITRANS 2 MAXTRANS 255 
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "USERS"  ENABLE
   ) SEGMENT CREATION IMMEDIATE 
  PCTFREE 10 PCTUSED 40 INITRANS 1 MAXTRANS 255 
 NOCOMPRESS LOGGING
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "USERS" ;

ALTER TABLE FAKEBOOK.USERS ADD "ROLE" VARCHAR2(100) DEFAULT 'NORMAL' NOT NULL;


CREATE TABLE "FAKEBOOK"."POSTS" 
   (	"ID" NUMBER(*,0) DEFAULT ON NULL FAKEBOOK.POSTS_ID_SEQ.NEXTVAL NOT NULL ENABLE, 
	"TEXT" VARCHAR2(100) NOT NULL ENABLE, 
	"IMAGE_URL" VARCHAR2(100), 
	"AUTHOR_ID" NUMBER(*,0), 
	 CONSTRAINT "POSTS_PK" PRIMARY KEY ("ID")
  USING INDEX PCTFREE 10 INITRANS 2 MAXTRANS 255 
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "USERS"  ENABLE
   ) SEGMENT CREATION IMMEDIATE 
  PCTFREE 10 PCTUSED 40 INITRANS 1 MAXTRANS 255 
 NOCOMPRESS LOGGING
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "USERS" ;

ALTER TABLE "FAKEBOOK"."POSTS" ADD CONSTRAINT "POSTS_USERS_FK" FOREIGN KEY ("AUTHOR_ID")
	  REFERENCES "FAKEBOOK"."USERS" ("ID") ON DELETE CASCADE ENABLE;


CREATE TABLE "FAKEBOOK"."COMMENTS" 
   (	"ID" NUMBER(*,0) DEFAULT ON NULL FAKEBOOK.COMMENTS_ID_SEQ.NEXTVAL NOT NULL ENABLE, 
	"TEXT" VARCHAR2(100) NOT NULL ENABLE, 
	"AUTHOR_ID" NUMBER(*,0), 
	"POST_ID" NUMBER(*,0) NOT NULL ENABLE, 
	 CONSTRAINT "COMMENTS_PK" PRIMARY KEY ("ID")
  USING INDEX PCTFREE 10 INITRANS 2 MAXTRANS 255 
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "USERS"  ENABLE
   ) SEGMENT CREATION IMMEDIATE 
  PCTFREE 10 PCTUSED 40 INITRANS 1 MAXTRANS 255 
 NOCOMPRESS LOGGING
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "USERS" ;

ALTER TABLE "FAKEBOOK"."COMMENTS" ADD CONSTRAINT "COMMENTS_POSTS_FK" FOREIGN KEY ("POST_ID")
	  REFERENCES "FAKEBOOK"."POSTS" ("ID") ON DELETE CASCADE ENABLE;
  ALTER TABLE "FAKEBOOK"."COMMENTS" ADD CONSTRAINT "COMMENTS_USERS_FK" FOREIGN KEY ("AUTHOR_ID")
	  REFERENCES "FAKEBOOK"."USERS" ("ID") ON DELETE SET NULL ENABLE;


CREATE TABLE "FAKEBOOK"."FRIENDS" 
   (	"ID" NUMBER(*,0) DEFAULT ON NULL FAKEBOOK.FRIENDS_ID_SEQ.NEXTVAL NOT NULL ENABLE, 
	"PENDING" NUMBER(2,1) DEFAULT 1 NOT NULL ENABLE, 
	"WHEN" DATE DEFAULT SYSDATE NOT NULL ENABLE, 
	"SENDER_ID" NUMBER(*,0) NOT NULL ENABLE, 
	"RECEIVER_ID" NUMBER(*,0) NOT NULL ENABLE, 
	 CONSTRAINT "FRIENDS_PENDING_CHECK" CHECK (PENDING IN (0, 1)) ENABLE, 
	 CONSTRAINT "FRIENDS_PK" PRIMARY KEY ("ID")
  USING INDEX PCTFREE 10 INITRANS 2 MAXTRANS 255 
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "USERS"  ENABLE
   ) SEGMENT CREATION IMMEDIATE 
  PCTFREE 10 PCTUSED 40 INITRANS 1 MAXTRANS 255 
 NOCOMPRESS LOGGING
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "USERS" ;

ALTER TABLE "FAKEBOOK"."FRIENDS" ADD CONSTRAINT "FRIENDS_USERS_FK" FOREIGN KEY ("SENDER_ID")
	  REFERENCES "FAKEBOOK"."USERS" ("ID") ON DELETE CASCADE ENABLE;
  ALTER TABLE "FAKEBOOK"."FRIENDS" ADD CONSTRAINT "FRIENDS_USERS_FK_1" FOREIGN KEY ("RECEIVER_ID")
	  REFERENCES "FAKEBOOK"."USERS" ("ID") ON DELETE CASCADE ENABLE;


CREATE TABLE "FAKEBOOK"."GROUPS" 
   (	"ID" NUMBER(*,0) DEFAULT ON NULL FAKEBOOK.GROUPS_ID_SEQ.NEXTVAL NOT NULL ENABLE, 
	"NAME" VARCHAR2(100) NOT NULL ENABLE, 
	"PRIVATE" NUMBER(2,1) DEFAULT 0 NOT NULL ENABLE, 
	 CONSTRAINT "GROUPS_PK" PRIMARY KEY ("ID")
  USING INDEX PCTFREE 10 INITRANS 2 MAXTRANS 255 COMPUTE STATISTICS 
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "USERS"  ENABLE, 
	 CONSTRAINT "GROUPS_UNIQUE" UNIQUE ("NAME")
  USING INDEX PCTFREE 10 INITRANS 2 MAXTRANS 255 COMPUTE STATISTICS 
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "USERS"  ENABLE, 
	 CONSTRAINT "GROUPS_PRIVATE_CHECK" CHECK (PRIVATE IN (0, 1)) ENABLE
   ) SEGMENT CREATION IMMEDIATE 
  PCTFREE 10 PCTUSED 40 INITRANS 1 MAXTRANS 255 
 NOCOMPRESS LOGGING
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "USERS" ;


CREATE TABLE "FAKEBOOK"."GROUP_MESSAGES" 
   (	"ID" NUMBER(*,0) DEFAULT ON NULL FAKEBOOK.GROUP_MESSAGES_ID_SEQ.NEXTVAL NOT NULL ENABLE, 
	"TEXT" VARCHAR2(100) NOT NULL ENABLE, 
	"WHEN" DATE DEFAULT SYSDATE NOT NULL ENABLE, 
	"GROUP_ID" NUMBER(*,0) NOT NULL ENABLE, 
	"SENDER_ID" NUMBER(*,0), 
	 CONSTRAINT "GROUP_MESSAGES_PK" PRIMARY KEY ("ID")
  USING INDEX PCTFREE 10 INITRANS 2 MAXTRANS 255 
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "USERS"  ENABLE
   ) SEGMENT CREATION IMMEDIATE 
  PCTFREE 10 PCTUSED 40 INITRANS 1 MAXTRANS 255 
 NOCOMPRESS LOGGING
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "USERS" ;

ALTER TABLE "FAKEBOOK"."GROUP_MESSAGES" ADD CONSTRAINT "GROUP_MESSAGES_GROUPS_FK" FOREIGN KEY ("GROUP_ID")
	  REFERENCES "FAKEBOOK"."GROUPS" ("ID") ON DELETE CASCADE ENABLE;
  ALTER TABLE "FAKEBOOK"."GROUP_MESSAGES" ADD CONSTRAINT "GROUP_MESSAGES_USERS_FK" FOREIGN KEY ("SENDER_ID")
	  REFERENCES "FAKEBOOK"."USERS" ("ID") ON DELETE SET NULL ENABLE;


CREATE TABLE "FAKEBOOK"."INTERESTS" 
   (	"ID" NUMBER(38,0) DEFAULT ON NULL "FAKEBOOK"."INTERESTS_ID_SEQ"."NEXTVAL" NOT NULL ENABLE, 
	"NAME" VARCHAR2(100) NOT NULL ENABLE, 
	 CONSTRAINT "INTERESTS_PK" PRIMARY KEY ("ID")
  USING INDEX PCTFREE 10 INITRANS 2 MAXTRANS 255 
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "USERS"  ENABLE, 
	 CONSTRAINT "INTERESTS_NAME_UNIQUE" UNIQUE ("NAME")
  USING INDEX PCTFREE 10 INITRANS 2 MAXTRANS 255 
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "USERS"  ENABLE
   ) SEGMENT CREATION IMMEDIATE 
  PCTFREE 10 PCTUSED 40 INITRANS 1 MAXTRANS 255 
 NOCOMPRESS LOGGING
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "USERS" ;


CREATE TABLE "FAKEBOOK"."MESSAGES" 
   (	"ID" NUMBER(*,0) DEFAULT ON NULL "FAKEBOOK"."MESSAGES_ID_SEQ"."NEXTVAL" NOT NULL ENABLE, 
	"TEXT" VARCHAR2(100) NOT NULL ENABLE, 
	"WHEN" DATE DEFAULT SYSDATE NOT NULL ENABLE, 
	"SENDER_ID" NUMBER(38,0), 
	"RECEIVER_ID" NUMBER(38,0), 
	 CONSTRAINT "MESSAGES_PK" PRIMARY KEY ("ID")
  USING INDEX PCTFREE 10 INITRANS 2 MAXTRANS 255 
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "USERS"  ENABLE
   ) SEGMENT CREATION IMMEDIATE 
  PCTFREE 10 PCTUSED 40 INITRANS 1 MAXTRANS 255 
 NOCOMPRESS LOGGING
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "USERS" ;

ALTER TABLE "FAKEBOOK"."MESSAGES" ADD CONSTRAINT "MESSAGES_USERS_FK" FOREIGN KEY ("SENDER_ID")
	  REFERENCES "FAKEBOOK"."USERS" ("ID") ON DELETE SET NULL ENABLE;
  ALTER TABLE "FAKEBOOK"."MESSAGES" ADD CONSTRAINT "MESSAGES_USERS_FK_1" FOREIGN KEY ("RECEIVER_ID")
	  REFERENCES "FAKEBOOK"."USERS" ("ID") ON DELETE SET NULL ENABLE;


CREATE TABLE "FAKEBOOK"."USER_GROUPS" 
   (	"ID" VARCHAR2(100) DEFAULT ON NULL FAKEBOOK.USER_GROUPS_ID_SEQ.NEXTVAL NOT NULL ENABLE, 
	"ROLE" VARCHAR2(100) DEFAULT 'NORMAL' NOT NULL ENABLE, 
	"USER_ID" NUMBER(*,0), 
	"GROUP_ID" NUMBER(*,0),  
	 CONSTRAINT "USER_GROUPS_PK" PRIMARY KEY ("ID")
  USING INDEX PCTFREE 10 INITRANS 2 MAXTRANS 255 
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "USERS"  ENABLE
   ) SEGMENT CREATION IMMEDIATE 
  PCTFREE 10 PCTUSED 40 INITRANS 1 MAXTRANS 255 
 NOCOMPRESS LOGGING
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "USERS" ;

ALTER TABLE "FAKEBOOK"."USER_GROUPS" ADD CONSTRAINT "USER_GROUPS_GROUPS_FK" FOREIGN KEY ("GROUP_ID")
	  REFERENCES "FAKEBOOK"."GROUPS" ("ID") ON DELETE CASCADE ENABLE;
  ALTER TABLE "FAKEBOOK"."USER_GROUPS" ADD CONSTRAINT "USER_GROUPS_USERS_FK" FOREIGN KEY ("USER_ID")
	  REFERENCES "FAKEBOOK"."USERS" ("ID") ON DELETE CASCADE ENABLE;


CREATE TABLE "FAKEBOOK"."USER_INTERESTS" 
   (	"ID" NUMBER(*,0) DEFAULT ON NULL "FAKEBOOK"."USER_INTERESTS_ID_SEQ"."NEXTVAL" NOT NULL ENABLE, 
	"USER_ID" NUMBER(*,0) NOT NULL ENABLE, 
	"INTEREST_ID" NUMBER(*,0) NOT NULL ENABLE, 
	 CONSTRAINT "USER_INTERESTS_PK" PRIMARY KEY ("ID")
  USING INDEX PCTFREE 10 INITRANS 2 MAXTRANS 255 
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "USERS"  ENABLE
   ) SEGMENT CREATION IMMEDIATE 
  PCTFREE 10 PCTUSED 40 INITRANS 1 MAXTRANS 255 
 NOCOMPRESS LOGGING
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "USERS" ;

ALTER TABLE "FAKEBOOK"."USER_INTERESTS" ADD CONSTRAINT "USER_INTERESTS_INTERESTS_FK" FOREIGN KEY ("INTEREST_ID")
	  REFERENCES "FAKEBOOK"."INTERESTS" ("ID") ON DELETE CASCADE ENABLE;
  ALTER TABLE "FAKEBOOK"."USER_INTERESTS" ADD CONSTRAINT "USER_INTERESTS_USERS_FK" FOREIGN KEY ("USER_ID")
	  REFERENCES "FAKEBOOK"."USERS" ("ID") ON DELETE CASCADE ENABLE;

-- FAKEBOOK.FORBIDDEN_EXPRESSIONS definition

CREATE TABLE "FAKEBOOK"."FORBIDDEN_EXPRESSIONS" 
   (	"ID" NUMBER(38,0) DEFAULT FAKEBOOK.FORBIDDEN_EXPRESSIONS_ID_SEQ.NEXTVAL NOT NULL ENABLE, 
	"PATTERN" VARCHAR2(100) NOT NULL ENABLE, 
	 CONSTRAINT "FORBIDDEN_EXPRESSIONS_PK" PRIMARY KEY ("ID")
  USING INDEX PCTFREE 10 INITRANS 2 MAXTRANS 255 
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "USERS"  ENABLE, 
	 CONSTRAINT "FORBIDDEN_EXPRESSIONS_UNIQUE" UNIQUE ("PATTERN")
  USING INDEX PCTFREE 10 INITRANS 2 MAXTRANS 255 
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "USERS"  ENABLE
   ) SEGMENT CREATION IMMEDIATE 
  PCTFREE 10 PCTUSED 40 INITRANS 1 MAXTRANS 255 
 NOCOMPRESS LOGGING
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "USERS" ;


-- Táblák feltöltése adatokkal

-- USERS
INSERT INTO FAKEBOOK.USERS (ID, EMAIL, FULLNAME, PASSWORD, BIRTH_DATE, COMPANY, ROLE)
VALUES (0, 'system@example.com', 'Fakebook System', '**', TO_DATE('1990-05-15', 'YYYY-MM-DD'), 'FakeBook Inc.', 'ADMIN');

INSERT INTO FAKEBOOK.USERS (ID, EMAIL, FULLNAME, PASSWORD, BIRTH_DATE, COMPANY, PICTURE_URL, ROLE)
VALUES (1, 'johndoe@example.com', 'John Doe', '$argon2id$v=19$m=65536,t=3,p=4$voBg+LKl57PyQW3BrttpXQ$H2Kmv776/syEl6BzBmYv+BjI+kL4Lt/wapkxDxVzf6M', TO_DATE('2025-05-19', 'YYYY-MM-DD'), 'FakeBook Inc.', 'http://example.com/johndoe.jpg', 'ADMIN');

INSERT INTO FAKEBOOK.USERS (ID, EMAIL, FULLNAME, PASSWORD, BIRTH_DATE, COMPANY, PICTURE_URL, ROLE )
VALUES (2, 'janedoe@example.com', 'Jane Doe', '$argon2id$v=19$m=65536,t=3,p=4$9h3S8Po5nYoRk3DmOD6kgA$wy/eKdSc5prUyfaWQrZSawBsVx/LO1O7wPT/zwQKItE', TO_DATE('1992-08-21', 'YYYY-MM-DD'), 'FakeBook Ltd.', 'http://example.com/janedoe.jpg', 'ADMIN');

INSERT INTO FAKEBOOK.USERS (ID, EMAIL, FULLNAME, PASSWORD, BIRTH_DATE, COMPANY, PICTURE_URL, ROLE)
VALUES (3, 'alexsmith@example.com', 'Alex Smith', '$argon2id$v=19$m=65536,t=3,p=4$qWSc3OVKNQ6mAy66wqUGZg$A0v/I//w5IE36jQVPrpZp/cTVsBLuOe9Prj/9RYoyok', TO_DATE('1985-11-10', 'YYYY-MM-DD'), 'Tech Inc.', NULL, 'MODERATOR');

INSERT INTO FAKEBOOK.USERS (ID, EMAIL, FULLNAME, PASSWORD, BIRTH_DATE, COMPANY, PICTURE_URL)
VALUES (4, 'emilyjones@example.com', 'Emily Jones', '$argon2id$v=19$m=65536,t=3,p=4$8sii2ixQu78DwljTA7dSRw$ypZi9e7wBEng4TEUggMLYj9x1U3JspdtDdNckeCsbmI', TO_DATE('1993-03-02', 'YYYY-MM-DD'), 'Creative Solutions', NULL);

INSERT INTO FAKEBOOK.USERS (ID, EMAIL, FULLNAME, PASSWORD, BIRTH_DATE, COMPANY, PICTURE_URL)
VALUES (5, 'michaelbrown@example.com', 'Michael Brown', '$argon2id$v=19$m=65536,t=3,p=4$KfmM1SBAqJYVEuecRb+vVQ$05i73xpHoR3s0eWn4eJHew4pI3ZRNeefo0yFwWnaXZg', TO_DATE('1989-07-19', 'YYYY-MM-DD'), 'Innovative Co.', NULL);

-- POSTS
INSERT INTO FAKEBOOK.POSTS (ID, TEXT, IMAGE_URL, AUTHOR_ID)
VALUES (1, 'This is my first post!', 'http://example.com/image1.jpg', 1);

INSERT INTO FAKEBOOK.POSTS (ID, TEXT, IMAGE_URL, AUTHOR_ID)
VALUES (2, 'Check out this cool picture!', NULL, 2);

INSERT INTO FAKEBOOK.POSTS (ID, TEXT, IMAGE_URL, AUTHOR_ID)
VALUES (3, 'Had a great day at the beach!', 'http://example.com/image3.jpg', 3);

INSERT INTO FAKEBOOK.POSTS (ID, TEXT, IMAGE_URL, AUTHOR_ID)
VALUES (4, 'Just finished a great book!', 'http://example.com/image4.jpg', 4);

INSERT INTO FAKEBOOK.POSTS (ID, TEXT, IMAGE_URL, AUTHOR_ID)
VALUES (5, 'Started learning a new programming language!', NULL, 5);

-- COMMENTS
INSERT INTO FAKEBOOK.COMMENTS (TEXT, AUTHOR_ID, POST_ID)
VALUES ('Great post!', 2, 1);

INSERT INTO FAKEBOOK.COMMENTS (TEXT, AUTHOR_ID, POST_ID)
VALUES ('Nice picture!', 1, 2);

INSERT INTO FAKEBOOK.COMMENTS (TEXT, AUTHOR_ID, POST_ID)
VALUES ('Looks like a fun day!', 3, 3);

INSERT INTO FAKEBOOK.COMMENTS (TEXT, AUTHOR_ID, POST_ID)
VALUES ('I also loved that book!', 4, 4);

INSERT INTO FAKEBOOK.COMMENTS (TEXT, AUTHOR_ID, POST_ID)
VALUES ('Good luck with your coding journey!', 5, 5);

-- FRIENDS
INSERT INTO FAKEBOOK.FRIENDS (PENDING, SENDER_ID, RECEIVER_ID)
VALUES (1, 1, 2);

INSERT INTO FAKEBOOK.FRIENDS (PENDING, SENDER_ID, RECEIVER_ID)
VALUES (0, 2, 1);

INSERT INTO FAKEBOOK.FRIENDS (PENDING, SENDER_ID, RECEIVER_ID)
VALUES (1, 3, 4);

INSERT INTO FAKEBOOK.FRIENDS (PENDING, SENDER_ID, RECEIVER_ID)
VALUES (0, 4, 3);

INSERT INTO FAKEBOOK.FRIENDS (PENDING, SENDER_ID, RECEIVER_ID)
VALUES (1, 5, 1);

-- GROUPS
INSERT INTO FAKEBOOK.GROUPS (ID,NAME,PRIVATE) VALUES (28,'TestGG2',1);

INSERT INTO FAKEBOOK.GROUPS (ID,NAME,PRIVATE) VALUES (1,'Tech Enthusiasts',0);

INSERT INTO FAKEBOOK.GROUPS (ID,NAME,PRIVATE) VALUES (3,'Music Fans',0);

INSERT INTO FAKEBOOK.GROUPS (ID,NAME,PRIVATE) VALUES (4,'Travel Addicts',0);

INSERT INTO FAKEBOOK.GROUPS (ID,NAME,PRIVATE) VALUES (5,'Cooking Lovers',0);


-- GROUP_MESSAGES
INSERT INTO FAKEBOOK.GROUP_MESSAGES (TEXT, GROUP_ID, SENDER_ID)
VALUES ('Hello group!', 1, 1);

INSERT INTO FAKEBOOK.GROUP_MESSAGES (TEXT, GROUP_ID, SENDER_ID)
VALUES ('Anyone here a fan of rock music?', 3, 3);

INSERT INTO FAKEBOOK.GROUP_MESSAGES (TEXT, GROUP_ID, SENDER_ID)
VALUES ('I''m planning a trip to Italy!', 4, 4);

INSERT INTO FAKEBOOK.GROUP_MESSAGES (TEXT, GROUP_ID, SENDER_ID)
VALUES ('Does anyone have a good recipe for lasagna?', 5, 5);

-- INTERESTS
INSERT INTO FAKEBOOK.INTERESTS (ID, NAME)
VALUES (1,'Technology');

INSERT INTO FAKEBOOK.INTERESTS (ID, NAME)
VALUES (2,'Reading');

INSERT INTO FAKEBOOK.INTERESTS (ID, NAME)
VALUES (3,'Music');

INSERT INTO FAKEBOOK.INTERESTS (ID, NAME)
VALUES (4,'Travel');

INSERT INTO FAKEBOOK.INTERESTS (ID, NAME)
VALUES (5,'Cooking');

-- MESSAGES
INSERT INTO FAKEBOOK.MESSAGES (TEXT, SENDER_ID, RECEIVER_ID)
VALUES ('Hey, how are you?', 1, 2);

INSERT INTO FAKEBOOK.MESSAGES (TEXT, SENDER_ID, RECEIVER_ID)
VALUES ('I''m doing well, thanks!', 2, 1);

INSERT INTO FAKEBOOK.MESSAGES (TEXT, SENDER_ID, RECEIVER_ID)
VALUES ('What time is our meeting tomorrow?', 3, 4);

INSERT INTO FAKEBOOK.MESSAGES (TEXT, SENDER_ID, RECEIVER_ID)
VALUES ('I finished the project! Check it out!', 4, 5);

INSERT INTO FAKEBOOK.MESSAGES (TEXT, SENDER_ID, RECEIVER_ID)
VALUES ('Can''t wait for our vacation together!', 5, 1);

-- USER_GROUPS

-- USER_INTERESTS
INSERT INTO FAKEBOOK.USER_GROUPS (ID,"ROLE",USER_ID,GROUP_ID) VALUES ('36','PENDING',1,28);

INSERT INTO FAKEBOOK.USER_GROUPS (ID,"ROLE",USER_ID,GROUP_ID) VALUES ('17','OWNER',2,28);

INSERT INTO FAKEBOOK.USER_GROUPS (ID,"ROLE",USER_ID,GROUP_ID) VALUES ('1','OWNER',1,1);

INSERT INTO FAKEBOOK.USER_GROUPS (ID,"ROLE",USER_ID,GROUP_ID) VALUES ('4','NORMAL',4,4);

INSERT INTO FAKEBOOK.USER_GROUPS (ID,"ROLE",USER_ID,GROUP_ID) VALUES ('5','OWNER',5,5);


INSERT INTO FAKEBOOK.FORBIDDEN_EXPRESSIONS (PATTERN) VALUES ('BUZI');
INSERT INTO FAKEBOOK.FORBIDDEN_EXPRESSIONS (PATTERN) VALUES ('FASZ');
INSERT INTO FAKEBOOK.FORBIDDEN_EXPRESSIONS (PATTERN) VALUES ('KURVA');
INSERT INTO FAKEBOOK.FORBIDDEN_EXPRESSIONS (PATTERN) VALUES ('KURWA');
INSERT INTO FAKEBOOK.FORBIDDEN_EXPRESSIONS (PATTERN) VALUES ('PUSSY');
INSERT INTO FAKEBOOK.FORBIDDEN_EXPRESSIONS (PATTERN) VALUES ('SZOPO');

-- DROP FUNCTION FAKEBOOK.IS_EXPRESSION_FORBIDDEN_FN;

-- Obszcén kifejezést nem tartalmazhat a fullname (egyelőre csak ez, később tervben lesz pl. a csoportnév)

-- Itt muszáj kétszer, különben nem látja a törzsben lévő paraméter hívást
CREATE OR REPLACE FUNCTION FAKEBOOK.IS_EXPRESSION_FORBIDDEN_FN (in_pattern IN VARCHAR2)
RETURN NUMBER IS
	match_count NUMBER;

CREATE OR REPLACE FUNCTION FAKEBOOK.IS_EXPRESSION_FORBIDDEN_FN (in_pattern IN VARCHAR2)
RETURN NUMBER IS
	match_count NUMBER;
BEGIN
	SELECT COUNT(PATTERN)
	INTO match_count
	FROM FAKEBOOK.FORBIDDEN_EXPRESSIONS
	WHERE UPPER(in_pattern) LIKE UPPER('%' || pattern || '%');
	RETURN CASE WHEN match_count > 0 THEN 1 ELSE 0 END;
END;


-- Érzékeli a trigger, ha talál, hibát dob, aminek szövegét a backend értelmezi
CREATE OR REPLACE TRIGGER FAKEBOOK.CHECK_FULLNAME_T
BEFORE INSERT OR UPDATE OF FULLNAME ON FAKEBOOK.USERS
FOR EACH ROW
BEGIN
	IF FAKEBOOK.IS_EXPRESSION_FORBIDDEN_FN(:NEW.FULLNAME) = 1 THEN
		RAISE_APPLICATION_ERROR(-20001, 'FORBIDDEN_EXPRESSION');
	END IF;
END;

CREATE OR REPLACE TRIGGER FAKEBOOK.INTEREST_ALREADY_ADDED_T
BEFORE INSERT ON FAKEBOOK.USER_INTERESTS
FOR EACH ROW
DECLARE
	match_count NUMBER;
BEGIN
	SELECT COUNT(id)
	INTO match_count
	FROM FAKEBOOK.USER_INTERESTS
	WHERE user_id = :NEW.user_id AND interest_id = :NEW.interest_id;

	IF match_count > 0 THEN
		RAISE_APPLICATION_ERROR(-20001, 'INTEREST_ALREADY_ADDED');
	END IF;
END;

CREATE OR REPLACE TRIGGER FAKEBOOK.EXISTING_FRIEND_REQUEST_T
BEFORE INSERT ON FAKEBOOK.FRIENDS
FOR EACH ROW
DECLARE
	match_count NUMBER;
BEGIN
	SELECT COUNT(id)
	INTO match_count
	FROM FAKEBOOK.FRIENDS
	WHERE sender_id = :NEW.sender_id AND receiver_id = :NEW.receiver_id
	OR sender_id = :NEW.receiver_id AND receiver_id = :NEW.sender_id;

	IF match_count > 0 THEN
		RAISE_APPLICATION_ERROR(-20001, 'FRIEND_ALREADY_ADDED');
	END IF;
END;


CREATE OR REPLACE TRIGGER FAKEBOOK.post_content_check
BEFORE INSERT OR UPDATE ON FAKEBOOK.POSTS
FOR EACH ROW
BEGIN  
  IF FAKEBOOK.IS_EXPRESSION_FORBIDDEN_FN(:NEW.TEXT) = 1 THEN
    RAISE_APPLICATION_ERROR(-20001, 'FORBIDDEN_EXPRESSION');
  END IF;
END;

CREATE OR REPLACE TRIGGER FAKEBOOK.comment_content_check
BEFORE INSERT OR UPDATE OF TEXT ON FAKEBOOK.COMMENTS
FOR EACH ROW
DECLARE
BEGIN  
  IF FAKEBOOK.IS_EXPRESSION_FORBIDDEN_FN(:NEW.TEXT) = 1 THEN
    RAISE_APPLICATION_ERROR(-20002, 'FORBIDDEN_EXPRESSION_IN_COMMENT');
  END IF;
END;

CREATE OR REPLACE TRIGGER FAKEBOOK.prevent_selffriending
BEFORE INSERT ON FAKEBOOK.FRIENDS
FOR EACH ROW
BEGIN
  IF :NEW.SENDER_ID = :NEW.RECEIVER_ID THEN
    RAISE_APPLICATION_ERROR(-20003, 'CANNOT_FRIEND_YOURSELF');
  END IF;
END;

CREATE OR REPLACE TRIGGER FAKEBOOK.prevent_group_owner_removal
BEFORE DELETE ON FAKEBOOK.USER_GROUPS
FOR EACH ROW
BEGIN
  IF :OLD.ROLE = 'OWNER' THEN
    RAISE_APPLICATION_ERROR(-20004, 'CANNOT_REMOVE_GROUP_OWNER');
  END IF;
END;

CREATE OR REPLACE FUNCTION FAKEBOOK.GROUP_MEMBER_COUNT_FN (in_group_id IN NUMBER)
RETURN NUMBER IS
	member_count NUMBER;

CREATE OR REPLACE FUNCTION FAKEBOOK.GROUP_MEMBER_COUNT_FN (in_group_id IN NUMBER)
RETURN NUMBER IS
	member_count NUMBER;
BEGIN
	SELECT COUNT(UG.USER_ID)
		INTO member_count
		FROM FAKEBOOK.USER_GROUPS UG
        WHERE UG.GROUP_ID = in_group_id;
	RETURN member_count;
END;

CREATE OR REPLACE FUNCTION FAKEBOOK.GROUP_MEMBER_COUNT_FN (in_group_id IN NUMBER)
RETURN NUMBER IS
	member_count NUMBER;
BEGIN
	SELECT COUNT(UG.USER_ID)
		INTO member_count
		FROM FAKEBOOK.USER_GROUPS UG
        WHERE UG.GROUP_ID = in_group_id;
	RETURN member_count;
END;
